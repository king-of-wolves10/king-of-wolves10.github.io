<link rel="stylesheet" href="generic.css">
<link rel="icon" href="../favicon.ico">
<title>Mahjong - king_of_wolves10 </title>
<body>

<a href="../index.html" >Go home</a><br>

<canvas id="screen" style="background-color:green" width="800px" height="600px"></canvas>
</body>

<script src="mahjong/board.txt"></script>
<script>
c = document.getElementById("screen")
cc = c.getContext('2d');

flowers = ['42','41','40','39']
Seasons = ['38','37','36','35']
map = [];
crap = [];
selectedTiles = [];

freetiles = [];

c.width = 800; c.height = 600;
i = 1; tiles = new Image(); tiles.src = "mahjong/mahjong.png";
cc.fillStyle = "white"
function draw( depth ){



i = 1;
while( game['p' + i] != undefined ){

tileIndex = game['v' + i].toString().slice(0,2) - 0
tileDepth = game['v' + i].toString().slice(3,4) - 0
tileX = game['p' + i][0] - 0
tileY = 0 + game['p' + i][1] - 0



if(tileIndex - 0 != 0){
	map[tileDepth][tileY][tileX] = {"idx": tileIndex - 0, "crap": i}
}

if(tileDepth - 0 == depth & tileIndex - 0 != 0 ){
	
if(map[tileDepth][tileY][tileX - 2] == undefined ){
	
	//draw top half of side
	if(map[tileDepth][tileY - 1] == undefined){
		cc.drawImage(tiles, 1872,0,8,25,(tileX * 20) + (tileDepth * 8) - 8, (tileY * 25) - (tileDepth * 8),8,25 )
	}else if( map[tileDepth][tileY - 1][tileX - 2] == undefined ) {
		cc.drawImage(tiles, 1872,0,8,25,(tileX * 20) + (tileDepth * 8) - 8, (tileY * 25) - (tileDepth * 8),8,25 )
	}
	
	//draw bottom half
	if(map[tileDepth][tileY + 1] == undefined){
		
		
		
		if(map[tileDepth][tileY + 2] == undefined){
			cc.drawImage(tiles, 1872,25,8,33,(tileX * 20) + (tileDepth * 8) - 8, (tileY * 25) - (tileDepth * 8) + 25,8,33 )
		}else if(map[tileDepth][tileY + 2][tileX] == undefined){
			
			if(map[tileDepth][tileY + 2][tileX - 2] == undefined ){
				cc.drawImage(tiles, 1872,25,8,33,(tileX * 20) + (tileDepth * 8) - 8, (tileY * 25) - (tileDepth * 8) + 25,8,33 )
			}else{
				cc.drawImage(tiles, 1872,25,8,25,(tileX * 20) + (tileDepth * 8) - 8, (tileY * 25) - (tileDepth * 8) + 25,8,25 )
			}
			
		}else{
			
			
			if(map[tileDepth][tileY + 2][tileX - 2] == undefined ){
				cc.drawImage(tiles, 1872,25,8,33,(tileX * 20) + (tileDepth * 8) - 8, (tileY * 25) - (tileDepth * 8) + 23,8,33 )
			}else{
				cc.drawImage(tiles, 1872,25,8,25,(tileX * 20) + (tileDepth * 8) - 8, (tileY * 25) - (tileDepth * 8) + 25,8,25 )
			}
			
		}
		
	}else if( map[tileDepth][tileY + 1][tileX - 2] == undefined ) {
		
		if( map[tileDepth][tileY + 2] == undefined ){
			cc.drawImage(tiles, 1872,25,8,33,(tileX * 20) + (tileDepth * 8) - 8, (tileY * 25) - (tileDepth * 8) + 23,8,33 )
		}else if(map[tileDepth][tileY + 2][tileX - 2] != undefined ) {
			cc.drawImage(tiles, 1872,25,8,25,(tileX * 20) + (tileDepth * 8) - 8, (tileY * 25) - (tileDepth * 8) + 25,8,25 )
		}else{
			cc.drawImage(tiles, 1872,25,8,33,(tileX * 20) + (tileDepth * 8) - 8, (tileY * 25) - (tileDepth * 8) + 23,8,33 )
		}
			
	}
	
	

}
//draw bottom side
if(map[tileDepth][tileY + 2] == undefined ){
	
	if(map[tileDepth][tileY][tileX - 2] == undefined ){
		
		if(map[tileDepth][tileY + 1] == undefined){
			cc.drawImage(tiles, 1872,59,49,8,(tileX * 20) + (tileDepth * 8) - 8, (tileY * 25) - (tileDepth * 8) + 50,49,8 )
		}else if( map[tileDepth][tileY + 1][tileX - 2] == undefined ){
			cc.drawImage(tiles, 1872,59,49,8,(tileX * 20) + (tileDepth * 8) - 8, (tileY * 25) - (tileDepth * 8) + 50,49,8 )
		}else{
			cc.drawImage(tiles, 1880,59,41,8,(tileX * 20) + (tileDepth * 8), (tileY * 25) - (tileDepth * 8) + 50,41,8 )
		}

	}else if( map[tileDepth][tileY][tileX - 2] != undefined ){
		cc.drawImage(tiles, 1872,59,49,8,(tileX * 20) + (tileDepth * 8) - 8, (tileY * 25) - (tileDepth * 8) + 50,49,8 )
	}else{

		cc.drawImage(tiles, 1872,59,49,8,(tileX * 20) + (tileDepth * 8) - 8, (tileY * 25) - (tileDepth * 8) + 50,49,8 )

	}
	
}else if(map[tileDepth][tileY + 2][tileX] == undefined){
	
	if( map[tileDepth][tileY + 2][tileX - 2] == undefined ){
		cc.drawImage(tiles, 1872,59,49,8,(tileX * 20) + (tileDepth * 8) - 8, (tileY * 25) - (tileDepth * 8) + 50,49,8 )
	}else{
		cc.drawImage(tiles, 1880,59,41,8,(tileX * 20) + (tileDepth * 8), (tileY * 25) - (tileDepth * 8) + 50,41,8 )
	}
}
	
//draw face
cc.drawImage(tiles, (tileIndex - 1) * 40,0,40,50,(tileX * 20) + (tileDepth * 8), (tileY * 25) - (tileDepth * 8),40,50 )

if(selectedTiles.includes(i) ){
	cc.fillStyle = '#ff81006e'
	cc.fillRect( (tileX * 20) + (tileDepth * 8), (tileY * 25) - (tileDepth * 8),40,50  )
}

if(isObstructed(tileDepth,tileX,tileY) == false ){
	
	
	
	//if(tileDepth == 4 & tileX == 13 & tileY == 6 ){console.log( 'isObstructed('+ tileDepth +',' + tileY + ',' + tileX + ')' ) }
	if(flowers.includes(tileIndex) ){ freetiles[freetiles.length] = flowers[0];  }
	else if(Seasons.includes(tileIndex) ){ freetiles[freetiles.length] = Seasons[0];  }
	else{ freetiles[freetiles.length] = tileIndex;  }

}else{
	
	cc.fillStyle = 'rgb(0,0,0,0.2 )'
	cc.fillRect( (tileX * 20) + (tileDepth * 8), (tileY * 25) - (tileDepth * 8),40,50  )

}


}
i++
}

}

function pleaseWork(d,y,x,q,num){

game['v' + q] = '00'.slice(0,2 - num.toString().length) + num + '' + '00'.slice(0,2 - d.toString().length) + d;
//map[d][y][x] = {"idx":num, "crap":q }
}


function loadBoard(){
	cc.translate(0,100);
	cc.clearRect(0,0,800,600);
	for(d=1; game['v' + d] != undefined; d++){
		var idx = 0;
		var dep = 0;

		if(game['v' + d].toString().length <= 2 ){
			dep = game['v' + d]
			crap[d] = {'depth': game['v' + d],'x': game['p' + d][0] ,'y': game['p' + d][1] };
			game['v' + i] = '00' + '00'.slice(0,2 - game['v' + d].toString().length) + game['v' + d]
		}else{
			crap[d] = {'depth': game['v' + d].slice(2),'x': game['p' + d][0] ,'y': game['p' + d][1] };
			dep = game['v' + d].slice(2)
			idx = game['v' + d].slice(0,2)
		}		
		var ex = game['p' + d][0]; var why = game['p' + d][1];
		
		if(map[dep] == undefined ){map[dep] = []; }
		if(map[dep][why] == undefined ){map[dep][why] = []; }
		map[dep][why][ex] = idx
	}

pairsUsed = []; done = 0;
cardsUsed = []; card = Math.round( Math.random() * 41 ) + 1;
pair = 0; q = 1; tilesDone = 0;

for( q=1; q<crap.length; q++){
d = crap[q].depth
x = crap[q].x
y = crap[q].y
		
pleaseWork(d,y,x,q, 43);
}



d=1;
while(map[d] != undefined){
draw(d); 
d++
}


cc.translate(0,-100);

var f = new FontFace('Mahjong', 'url(mahjong/MahJongCamb.ttf)');

f.load().then(function(font) {

	// Ready to use the font in a canvas context


	// Add font on the html page
	document.fonts.add(font);
	
	cc.font = '20px Mahjong';
	
})

window.requestAnimationFrame(loop)

}



var dingsfx = new Audio; dingsfx.src = "mahjong/ding.wav"
var badmovesfx = new Audio; badmovesfx.src = "mahjong/badmove.wav"
var selectsfx = new Audio; selectsfx.src = "mahjong/select.wav"

var mx = 0; 
var bg = new Image; bg.src = "mahjong/sky.png"
var my = 0;
var border = new Image; border.src = "mahjong/border.png"
var testDepth = 1;
var handOffset = 0;
function loop(){
	
	
	freetiles = [];
	cc.clearRect(0,0,c.width,c.height)
	cc.drawImage(bg,0,80)
	
	deWX =  Math.floor( mx / 40 )
	deHX = Math.floor( mx / 20 )
	
	d=1;
	cc.translate(0,100);
	while(map[d] != undefined){
		draw(d); 
		d++
	}
	cc.translate(0,-100);

freetiles.sort();
goodmove = 0; i = 0;



for(i=0; i<freetiles.length; i++){
	
	if(freetiles[i] == freetiles[i + 1] ){ goodmove ++; i++ }
}

cc.fillStyle = "gray"
cc.fillRect(0,c.height - 80,c.width,80)
cc.fillRect(0,0,c.width,80)


cc.fillStyle = "white"; cc.font = '20px Mahjong';
cc.fillText("Board may not be solvable yet",16,16);

cc.font = '15px Mahjong';
cc.fillText("Available Moves",16,40);

cc.drawImage(border,40,50,60,20);
cc.fillStyle = "aqua"
cc.fillText(goodmove,60,65,40);

window.requestAnimationFrame(loop)
}

c.addEventListener('mousemove',function(eevee){
	
	mx = eevee.offsetX //- 20;
	my = eevee.offsetY;

	
	
})

ignorelist = [];

function dothething(){
ignorelist = [];	
	for(i=1; i<crap.length; i++){
		
		d = crap[i].depth
		x = crap[i].x
		y = crap[i].y
		if(isObstructed(d,x,y) == false){ ignorelist[ignorelist.length] = i; pleaseWork(d,x,y,i,5)  }
		
	}
	


}

c.addEventListener('mouseup',function(eevee){
	
	


	while(map[d] != undefined){
		d++
	}
	d--
	
	while(d > 0){
	var ding = false
	var twx = Math.floor( (  (mx - 20) - (d * 8) ) / 40 )
	var thx = Math.floor( (  mx - (d * 8) ) / 40 )

	var twy = Math.floor( (  (my - 25) + (d * 8) ) / 50 )
	var thy = Math.floor( (  my + (d * 8) ) / 50 )
	

	twx = twx * 2 + 1
	thx = thx * 2
	

	thy = (thy - 2) * 2
	twy = (twy - 1) * 2 - 1

			
	if(map[d][thy] != undefined){
		if(map[d][thy][thx] != undefined & map[d][thy][thx] != 0 ){
			selectTile( map[d][thy][thx].crap )	
			d = 0; ding = true
			
		}else if( map[d][thy][twx] != undefined ){
			selectTile( map[d][thy][twx].crap )
			d = 0; ding = true
		}
	}
	if(map[d] == undefined){continue}
	if(map[d][twy] != undefined & ding == false){
		if(map[d][twy][thx] != undefined ){
			selectTile( map[d][twy][thx].crap )
			d = 0; 
			ding = true;
		}else if( map[d][twy][twx] != undefined ){
			selectTile( map[d][twy][twx].crap )
			d = 0; 
			ding = true;
		}
		
		
	}
	
	
	d--
	}
	if(ding == false){badmovesfx.play() }
	
})



function isObstructed(de,ex,wy){
	
	if(map[de + 1] != undefined){
		
		if(map[de + 1][wy] != undefined){
			
			if(map[de + 1][wy][ex] != undefined){ return true}
			if(map[de + 1][wy][ex + 1] != undefined){ return true}
			if(map[de + 1][wy][ex - 1] != undefined){ return true}
		}
		
		if(map[de + 1][wy - 1] != undefined){
			if(map[de + 1][wy - 1][ex] != undefined){ return true}
			if(map[de + 1][wy - 1][ex + 1] != undefined){ return true}
			if(map[de + 1][wy - 1][ex - 1] != undefined){ return true}			
		}

		if(map[de + 1][wy + 1] != undefined){
			if(map[de + 1][wy + 1][ex] != undefined){ return true}
			if(map[de + 1][wy + 1][ex + 1] != undefined){ return true}
			if(map[de + 1][wy + 1][ex - 1] != undefined){ return true}			
		}		
		
		
	}

	if(map[de][wy][ex + 2] != undefined & map[de][wy][ex - 2] != undefined ){ return true }
	
	if(map[de][wy + 1] != undefined){
		if(map[de][wy + 1][ex + 2] != undefined & map[de][wy + 1][ex - 2] != undefined ){ return true}
		if(map[de][wy + 1][ex + 2] != undefined & map[de][wy][ex - 2] != undefined ){ return true}
		if(map[de][wy][ex + 2] != undefined & map[de][wy + 1][ex - 2] != undefined ){ return true}
	}
	
	if(map[de][wy - 1] != undefined){
		if(map[de][wy - 1][ex - 2] != undefined & map[de][wy - 1][ex + 2] != undefined ){ return true }
		if(map[de][wy - 1][ex - 2] != undefined & map[de][wy][ex + 2] != undefined ){ return true }
		
		if(map[de][wy][ex - 2] != undefined & map[de][wy - 1][ex + 2] != undefined ){ return true }

		if(map[de][wy - 1][ex - 2] != undefined & map[de][wy][ex + 2] != undefined){ return true }
	}
	
	
return false
}

function checkforNil(de,ex,wy){
	
	if(map[de] != undefined){
	
	if(map[de][wy] != undefined){
			
			if(map[de][wy][ex] != undefined){ return true}// if(map[de][wy][ex].idx == 0){ return true} }
			if(map[de][wy][ex + 1] != undefined){ return true}//if(map[de][wy][ex + 1].idx == 0){ return true} }
			if(map[de][wy][ex - 1] != undefined){ return true}//if(map[de][wy][ex - 1].idx == 0){ return true} }

		}
	}
}



function selectTile(cr){
	
	var tileDE = game['v' + cr].slice(2) - 0
	var tileEX = game['p' + cr][0]
	var tileWY = game['p' + cr][1]

	if(isObstructed(tileDE,tileEX,tileWY) ){badmovesfx.play(); return}
	
	
	idx1 = 0; idx2 = -1;
	if(selectedTiles.length > 0){
		idx1 = game['v' + cr].slice(0,2); idx2 = game['v' + selectedTiles[0] ].slice(0,2)
	if(  idx1 != idx2  ){
		
		if(flowers.includes(idx1) & flowers.includes(idx2)  ){idx1 = idx2; console.log("flower") }
		else if( Seasons.includes(idx1) & Seasons.includes(idx2) ){idx1 = idx2; console.log("season") }
		else{selectedTiles = []; idx1 = 0; idx2 = -1; badmovesfx.play(); return}
		
		}
	}
	
	if(selectedTiles.includes(cr) ){
		
		if(selectedTiles[0] == cr){selectedTiles[0] = undefined }else{ selectedTiles[1] = undefined; idx1 = 0; idx2 = -1; }
		if(selectedTiles.length > 0 ){ selectedTiles = selectedTiles.filter( Number ); idx1 = 0; idx2 = -1;}
	}else{
		selectedTiles[selectedTiles.length] = cr
	}
	if(idx1 != idx2){selectsfx.play() }
	if( idx1 == idx2 ){
		dingsfx.play()
		eraseTile(selectedTiles[0]); eraseTile(selectedTiles[1]); selectedTiles = [];
	}
}

function eraseTile(cr){
	
	if( game['v' + cr] == undefined){return}
	
	d = game['v' + cr].slice(2) - 0
	idx = game['v' + cr].slice(0,2) - 0
	x = game['p' + cr][0]
	y = game['p' + cr][1]
	
	
	pleaseWork(d,y,x,cr,0 )
	map[d][y][x] = undefined
	
}
window.onload = function(e){ loadBoard() }
</script>